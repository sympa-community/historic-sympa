<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">

<!--Converted with LaTeX2HTML 2002-2-1 (1.70)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>20. Lists Families</TITLE>
<META NAME="description" CONTENT="20. Lists Families">
<META NAME="keywords" CONTENT="sympa">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<META NAME="Generator" CONTENT="LaTeX2HTML v2002-2-1">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="sympa.css">

<LINK REL="next" HREF="node22.html">
<LINK REL="previous" HREF="node20.html">
<LINK REL="up" HREF="sympa.html">
<LINK REL="next" HREF="node22.html">
</HEAD>

<BODY TEXT="#000000" BGCOLOR="#ffffff">
<!--Navigation Panel-->
<A NAME="tex2html1390"
  HREF="node22.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html1384"
  HREF="sympa.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html1378"
  HREF="node20.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html1386"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html1388"
  HREF="node31.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> 
<BR>
<B> Next:</B> <A NAME="tex2html1391"
  HREF="node22.html">21. List configuration parameters</A>
<B> Up:</B> <A NAME="tex2html1385"
  HREF="sympa.html">Sympa Mailing Lists Management Software version</A>
<B> Previous:</B> <A NAME="tex2html1379"
  HREF="node20.html">19. List creation, edition and removal</A>
 &nbsp; <B>  <A NAME="tex2html1387"
  HREF="node1.html">Contents</A></B> 
 &nbsp; <B>  <A NAME="tex2html1389"
  HREF="node31.html">Index</A></B> 
<BR>
<BR>
<!--End of Navigation Panel-->
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><STRONG>Subsections</STRONG></A>

<UL>
<LI><A NAME="tex2html1392"
  HREF="node21.html#SECTION002110000000000000000">20.1 Family concept</A>
<LI><A NAME="tex2html1393"
  HREF="node21.html#SECTION002120000000000000000">20.2 Using family</A>
<UL>
<LI><A NAME="tex2html1394"
  HREF="node21.html#SECTION002121000000000000000">20.2.1 Definition</A>
<LI><A NAME="tex2html1395"
  HREF="node21.html#SECTION002122000000000000000">20.2.2 Instantiation</A>
<LI><A NAME="tex2html1396"
  HREF="node21.html#SECTION002123000000000000000">20.2.3 Modification</A>
<LI><A NAME="tex2html1397"
  HREF="node21.html#SECTION002124000000000000000">20.2.4 Closure</A>
<LI><A NAME="tex2html1398"
  HREF="node21.html#SECTION002125000000000000000">20.2.5 Adding one list</A>
<LI><A NAME="tex2html1399"
  HREF="node21.html#SECTION002126000000000000000">20.2.6 Removing one list</A>
<LI><A NAME="tex2html1400"
  HREF="node21.html#SECTION002127000000000000000">20.2.7 Modifying one list</A>
<LI><A NAME="tex2html1401"
  HREF="node21.html#SECTION002128000000000000000">20.2.8 List parameters edition in a family context</A>
</UL>
<BR>
<LI><A NAME="tex2html1402"
  HREF="node21.html#SECTION002130000000000000000">20.3 Automatic list creation</A>
<UL>
<LI><A NAME="tex2html1403"
  HREF="node21.html#SECTION002131000000000000000">20.3.1 Configuring your MTA</A>
<LI><A NAME="tex2html1404"
  HREF="node21.html#SECTION002132000000000000000">20.3.2 Defining the list family</A>
<LI><A NAME="tex2html1405"
  HREF="node21.html#SECTION002133000000000000000">20.3.3 Configuring Sympa</A>
</UL></UL>
<!--End of Table of Child-Links-->
<HR>

<H1><A NAME="SECTION002100000000000000000"></A>
    <A NAME="lists-families"></A>    <A NAME="2928"></A>
<BR>
20. Lists Families
</H1>

<P>
A list can have from three parameters to many tens of them. Some listmasters need to create 
a set of lists that have the same profile. In order to simplify the apprehension of these parameters, 
list families define a lists typology.
Families provide a new level for defaults : in the past, defaults in Sympa were global and 
most sites using Sympa needed multiple defaults for different group of lists.
Moreover families allow listmaster to delegate a part of configuration list to owners, in a controlled way 
according to family properties.
Distribution will provide defaults families.

<P>

<H1><A NAME="SECTION002110000000000000000"></A>
     <A NAME="family-concept"></A>
<BR>
20.1 Family concept
</H1>

<P>
A family provides a model for all of its lists. It is specified by the following characteristics :

<P>

<UL>
<LI>a list creation template providing a common profile for each list configuration file.
</LI>
<LI>an degree of independence between the lists and the family : list parameters edition rights and 
constraints on these parameters can be <I>free</I> (no constraint), <I>controlled</I> (a set of 
available values is defined for these parameters) or <I>fixed</I> (the value for the parameter is imposed by 
the family). That prevents lists from diverging from the original and it allows list owner customizations in 
a controlled way. 
</LI>
<LI>a filiation kept between lists and family all along the list life : family modifications 
are applied on lists while keeping listowners customizations.

<P>
</LI>
</UL>

<P>
Here is a list of operation performed on a family : 

<P>

<UL>
<LI>definition : definition of the list creation template, the degree of independence and family customizations.
</LI>
<LI>instantiation : lists creation or modifications of existing lists while respecting family properties.
          The set of data defining the lists is an XML document. 
</LI>
<LI>modification : modification of family properties. The modification is effective at the next instantiation time, that have consequences on every list.
</LI>
<LI>closure : closure of each list.
</LI>
<LI>adding one list to a family.
</LI>
<LI>closing one family list.
</LI>
<LI>modifying one family list.

<P>
</LI>
</UL>

<P>

<H1><A NAME="SECTION002120000000000000000"></A>
    <A NAME="using-family"></A>
<BR>
20.2 Using family
</H1>

<P>

<H2><A NAME="SECTION002121000000000000000">
20.2.1 Definition</A>
</H2>
Families can be defined at the robot level, at  the site level or on the distribution level
 (where default families are provided).
So, you have to create a sub directory named after the family's name in a <A NAME="10915"></A><TT>families</TT> directory  : 

<P>
<I>Examples:</I> <PRE>
/home/sympa/etc/families/my_family
/home/sympa/etc/my_robot/families/my_family
</PRE>
In this directory you must provide these files :

<UL>
<LI><A NAME="10918"></A><TT>config.tt2</TT> (mandatory)
</LI>
<LI><A NAME="10921"></A><TT>param_constraint.conf</TT> (mandatory)
</LI>
<LI><A NAME="10924"></A><TT>edit_list.conf</TT>
</LI>
<LI>customizable files
</LI>
</UL>

<P>

<H3><A NAME="SECTION002121100000000000000"></A>
   <A NAME="using-family-config-tpl"></A>
<BR>
20.2.1.1 config.tt2
</H3>
      This is a list creation template, this file is mandatory. It provides default values for parameters. 
      This file is an almost complete list configuration, with a number of missing fields 
      (such as owner e-mail) to be replaced by data obtained at the time of family instantiation.
      It is easy to create new list templates by modifying existing ones. See <A HREF="node19.html#list-tpl">18.8</A>, page&nbsp;<A HREF="node19.html#list-tpl"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>
      and <A HREF="node18.html#tpl-format">17.1</A>, page&nbsp;<A HREF="node18.html#tpl-format"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>.
<BR>
<P>
<I>Example:</I> <PRE>
subject [% subject %]

status [% status %]

[% IF topic %]
topics [% topic %]

[% END %]
visibility noconceal

send privateoreditorkey

web_archive
  access public

subscribe open_notify

shared_doc
  d_edit [% shared_edit %]
  d_read [% shared_read %]

lang [% language %]

[% FOREACH o = owner %]
owner
  email [% o.email %]
  profile privileged
  [% IF o.gecos %] 
  gecos [% o.gecos %]
  [% END %]

[% END %]
[% IF moderator %]
   [% FOREACH m = moderator %]
editor
  email [% m.email %]

   [% END %]
[% END %]
 
[% IF sql %]
include_sql_query
  db_type [% sql.type %]
  host [% sql.host %]
  user [% sql.user %]
  passwd [% sql.pwd %]
  db_name [% sql.name %]
  sql_query [% sql.query %]
    
[% END %]
ttl 360
</PRE>

<P>

<H3><A NAME="SECTION002121200000000000000"></A>
     <A NAME="2964"></A>
<BR>
20.2.1.2 param_constraint.conf
</H3>
         This file is obligatory. It defines constraints on parameters. There are three kind of constraints :
	 
<UL>
<LI><I>free</I> parameters : no constraint on these parameters, 
                  they are not written in the <A NAME="10927"></A><TT>param_constraint.conf</TT> file.
</LI>
<LI><I>controlled</I> parameters : these parameters must select their values 
                  in a set of available values indicated in the <A NAME="10930"></A><TT>param_constraint.conf</TT> file.
</LI>
<LI><I>fixed</I> parameters : these parameters must have the imposed value indicated
	          in the <A NAME="10933"></A><TT>param_constraint.conf</TT> file.

<P>
</LI>
</UL>
	 The parameters constraints will be checked at every list loading.

<P>
<B>WARNING</B> : Some parameters cannot be constrained, they are : <A NAME="10936"></A><TT>msg_topic.keywords</TT> 
(see&nbsp;<A HREF="node22.html#par-msg-topic">21.4.13</A>, page&nbsp;<A HREF="node22.html#par-msg-topic"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>),<A NAME="10939"></A><TT>owner_include.source_parameter</TT> 
(see&nbsp;<A HREF="node22.html#par-owner-include">21.1.6</A>, page&nbsp;<A HREF="node22.html#par-owner-include"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>), <A NAME="10942"></A><TT>editor_include.source_parameter</TT> (see&nbsp;<A HREF="node22.html#par-editor-include">21.1.2</A>, page&nbsp;<A HREF="node22.html#par-editor-include"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>). About <A NAME="10945"></A><TT>digest</TT> parameter (see&nbsp;<A HREF="node22.html#par-digest">21.4.9</A>, page&nbsp;<A HREF="node22.html#par-digest"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>) , just days can be constrained.

<P>
<I>Example:</I> <PRE>
lang                fr,us			
archive.period      days,week,month	
visibility          conceal,noconceal	
shared_doc.d_read   public		
shared_doc.d_edit   editor
</PRE>

<P>

<H3><A NAME="SECTION002121300000000000000">
20.2.1.3 edit_list.conf</A>
</H3>
        This is an optional file. It defines which parameters/files are editable by
	owners. See <A HREF="node20.html#list-edition">19.4.4</A>, page&nbsp;<A HREF="node20.html#list-edition"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>.
	If the family does not have this file, <I>Sympa</I> will look for 
	the one defined on robot level, server site level or distribution level. 
	(This file already exists without family context)
<BR>
Notes that by default parameter family_name is not writable, you should not change 
	this edition right.

<P>

<H3><A NAME="SECTION002121400000000000000">
20.2.1.4 customizable files</A>
</H3>
        Families provides a new level of customization for scenarios (see <A HREF="node15.html#scenarios">14</A>, 
	page&nbsp;<A HREF="node15.html#scenarios"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>), templates for service messages (see <A HREF="node18.html#site-tpl">17.2</A>, 
	page&nbsp;<A HREF="node18.html#site-tpl"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>) and templates for web pages (see <A HREF="node18.html#web-tpl">17.3</A> , 
	page&nbsp;<A HREF="node18.html#web-tpl"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>). <I>Sympa</I> looks for these files in the following 
	level order: list, family, robot, server site or distribution. 

<P>
<I>Example of custom hierarchy :</I> <PRE>
/usr/local/sympa-os/etc/families/myfamily/mail_tt2/
/usr/local/sympa-os/etc/families/myfamily/mail_tt2/bye.tt2
/usr/local/sympa-os/etc/families/myfamily/mail_tt2/welcome.tt2
</PRE>

<P>

<H2><A NAME="SECTION002122000000000000000"></A>
<A NAME="family-instantiation"></A>
<BR>
20.2.2 Instantiation
</H2>

<P>
Instantiation permits to generate lists.You must provide an XML file that is 
composed of lists description, the root element is <I>family</I> and is only 
composed of <I>list</I> elements. List elements are described in section 
<A HREF="node20.html#xml-file-format">19.1.2</A>, page&nbsp;<A HREF="node20.html#xml-file-format"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>. Each list is described 
by the set of values for affectation list parameters.

<P>
Here is an sample command to instantiate a family :<PRE>
sympa.pl --instantiate\_family my_family --robot \samplerobot --input\_file /path/to/my\_file.xml
</PRE>
This means lists that belong to family <A NAME="10948"></A><TT>my_family</TT> will be created under the robot 
<A NAME="10951"></A><TT>my_robot</TT> and these lists are described in the file <A NAME="10954"></A><TT>my_file.xml</TT>. Sympa will split this file 
into several xml files describing lists. Each list XML file is put in each list directory.
<BR>
<P>
<I>Example:</I> <PRE>
&lt;?xml version="1.0" ?&gt;
&lt;family&gt;
  &lt;list&gt;
    &lt;listname&gt;liste1&lt;/listname&gt;
    &lt;subject&gt;a list example&lt;/subject&gt;
    &lt;description/&gt;
    &lt;status&gt;open&lt;/status&gt;
    &lt;shared_edit&gt;editor&lt;/shared_edit&gt;
    &lt;shared_read&gt;private&lt;/shared_read&gt;
    &lt;language&gt;fr&lt;/language&gt;
    &lt;owner multiple="1"&gt; 
      &lt;email&gt;serge.aumont@cru.fr&lt;/email&gt; 
      &lt;gecos&gt;C.R.U.&lt;/gecos&gt;
    &lt;/owner&gt;
    &lt;owner multiple="1"&gt; 
      &lt;email&gt;olivier.salaun@cru.fr&lt;/email&gt;
    &lt;/owner&gt;
    &lt;owner_include multiple="1"&gt;
      &lt;source&gt;my_file&lt;/source&gt;
    &lt;/owner_include&gt;
    &lt;sql&gt; 
      &lt;type&gt;oracle&lt;/type&gt;
      &lt;host&gt;sqlserv.admin.univ-x.fr&lt;/host&gt;
      &lt;user&gt;stdutilisateur&lt;/user&gt;
      &lt;pwd&gt;monsecret&lt;/pwd&gt;
      &lt;name&gt;les_etudiants&lt;/name&gt;
      &lt;query&gt;SELECT DISTINCT email FROM etudiant&lt;/query&gt;
    &lt;/sql&gt;
  &lt;/list&gt;
  &lt;list&gt;
    &lt;listname&gt;liste2&lt;/listname&gt;
    &lt;subject&gt;a list example&lt;/subject&gt;
    &lt;description/&gt;
    &lt;status&gt;open&lt;/status&gt;
    &lt;shared_edit&gt;editor&lt;/shared_edit&gt;
    &lt;shared_read&gt;private&lt;/shared_read&gt;
    &lt;language&gt;fr&lt;/language&gt;
    &lt;owner multiple="1"&gt; 
      &lt;email&gt;serge.aumont@cru.fr&lt;/email&gt; 
      &lt;gecos&gt;C.R.U.&lt;/gecos&gt;
    &lt;/owner&gt;
    &lt;owner multiple="1"&gt; 
      &lt;email&gt;olivier.salaun@cru.fr&lt;/email&gt;
    &lt;/owner&gt;
    &lt;owner_include multiple="1"&gt;
      &lt;source&gt;my_file&lt;/source&gt;
    &lt;/owner_include&gt;
    &lt;sql&gt; 
      &lt;type&gt;oracle&lt;/type&gt;
      &lt;host&gt;sqlserv.admin.univ-x.fr&lt;/host&gt;
      &lt;user&gt;stdutilisateur&lt;/user&gt;
      &lt;pwd&gt;monsecret&lt;/pwd&gt;
      &lt;name&gt;les_etudiants&lt;/name&gt;
      &lt;query&gt;SELECT DISTINCT email FROM etudiant&lt;/query&gt;
    &lt;/sql&gt;
  &lt;/list&gt;
   ...
&lt;/family&gt;
</PRE>

<P>
Each instantiation describes lists. Compared to the previous instantiation, there are three cases :

<UL>
<LI>lists creation : new lists described by the new instantiation
</LI>
<LI>lists modification : lists already existing but possibly changed because of changed parameters values in
        the XML file or because of changed family's properties.
</LI>
<LI>lists removal : lists nomore described by the new instantiation. In this case, the listmaster must 
        valid his choice on command line. If the list is removed, it is set in status <A NAME="10957"></A><TT>family_closed</TT>, or if the 
	list is recovered, the list XML file from the previous instantiation is got back to go on as a list modification then.

<P>
</LI>
</UL>

<P>
After list creation or modification, parameters constraints are checked :

<UL>
<LI><I>fixed</I> parameter : the value must be the one imposed.
</LI>
<LI><I>controlled</I> parameter : the value must be one of the set of available values.
</LI>
<LI><I>free</I> parameter : there is no checking.

<P>
</LI>
</UL>

<P>
diagram

<P>
In case of modification (see diagram), allowed customizations can be preserved :

<UL>
<LI>(1) : for every modified parameters (via Web interface), noted in the <A NAME="10960"></A><TT>config_changes</TT> 
    file, values can be collected in the old list configuration file, according to new family properties :
    
<UL>
<LI><I>fixed</I> parameter : the value is not collected.
</LI>
<LI><I>controlled</I> parameter : the value is collected only if constraints are respected.
</LI>
<LI><I>free</I> parameter : the value is collected.
    
</LI>
</UL>
</LI>
<LI>(2) : a new list configuration file is made with the new family properties
</LI>
<LI>(3) : collected values are set in the new list configuration file.

<P>
</LI>
</UL>

<P>
Notes : 

<UL>
<LI>For each list problem (as family file error, error parameter constraint, error instanciation ...),
    the list is set in status <A NAME="10963"></A><TT>error_config</TT> and the listmaster is notified. He will have to do necessary to put list in use.
</LI>
<LI>For each list closing in family context, the list is set in status <A NAME="10966"></A><TT>family_closed</TT> and the owner is notified.
</LI>
<LI>For each overwritten list customization, the owner is notified. 
</LI>
</UL>

<P>

<H2><A NAME="SECTION002123000000000000000">
20.2.3 Modification</A>
</H2>
To modify a family, you have to edit family files manually. The modification will be effective while the next instanciation.
<BR><B>WARNING</B>: The family modification must be done just before an instantiation. If it is not, alive lists wouldn't respect 
new family properties and they would be set in status error_config immediately.

<P>

<H2><A NAME="SECTION002124000000000000000">
20.2.4 Closure</A>
</H2>

<P>
<A NAME="family-closure"></A>
<P>
Closes every list (installed under the indicated robot) 
 of this family : lists status are set to <A NAME="10969"></A><TT>family_closed</TT>, aliases are 
 removed and subscribers are removed from DB. (a dump is created in the list 
 directory to allow restoration of the list).

<P>
Here is a sample command to close a family :
 <PRE>
 sympa.pl --close_family my_family --robot \samplerobot
</PRE> 

<P>

<H2><A NAME="SECTION002125000000000000000">
20.2.5 Adding one list</A>
</H2>

<P>
<A NAME="family-add-list"></A>
<P>
Adds a list to the family without instantiate all the family. The list is created
 as if it was created during an instantiation, under the indicated robot. The XML file
 describes the list and the root element is <A NAME="10972"></A><TT>&lt;list&gt;</TT>. List elements are described in section 
 <A HREF="node20.html#list-creation-sympa">19.3</A>, page&nbsp;<A HREF="node20.html#list-creation-sympa"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>.

<P>
Here is a sample command to add a list to a family :
 <PRE>
 sympa.pl --add\_list my\_family --robot \samplerobot  --input\_file /path/to/my\_file.xml
</PRE> 

<P>

<H2><A NAME="SECTION002126000000000000000">
20.2.6 Removing one list</A>
</H2>

<P>
Closes the list  installed under the indicated robot : the list status is set to
  <A NAME="10975"></A><TT>family_closed</TT>, aliases are 
 removed and subscribers are removed from DB. (a dump is created in the list 
 directory to allow restoring the list).

<P>
Here is a sample command to close a list family (same as an orphan list) :
 <PRE>
 sympa.pl --close_list my_list@\samplerobot
</PRE> 

<P>

<H2><A NAME="SECTION002127000000000000000"></A>
 <A NAME="family-modify-list"></A>
<BR>
20.2.7 Modifying one list
</H2>

<P>
Modifies a family list without instantiating the whole family. The list (installed under the indicated robot) 
 is modified as if it was modified during an instantiation. The XML file
 describes the list and the root element is <A NAME="10978"></A><TT>&lt;list&gt;</TT>. List elements are described in section 
 <A HREF="node20.html#list-creation-sympa">19.3</A>, page&nbsp;<A HREF="node20.html#list-creation-sympa"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>.

<P>
Here is a sample command to modify a list to a family :
 <PRE>
 sympa.pl --modify\_list my\_family --robot \samplerobot --input\_file /path/to/my\_file.xml
</PRE> 

<P>

<H2><A NAME="SECTION002128000000000000000"></A>
    <A NAME="list-param-edit-family"></A>
<BR>
20.2.8 List parameters edition in a family context
</H2>
According to file <A NAME="10981"></A><TT>edit_list.conf</TT>, edition rights are controlled.  
See <A HREF="node20.html#list-edition">19.4.4</A>, page&nbsp;<A HREF="node20.html#list-edition"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>. But in a family context, constraints parameters are 
added to edition right as it is summarized in this array :
<BR>
<P>
array
<BR>
<P>
Note : In order to preserve list customization for instantiation, every modified parameter (via the Web interface) is noted in the <A NAME="10984"></A><TT>config_changes</TT> file. 

<P>

<H1><A NAME="SECTION002130000000000000000"></A>
 <A NAME="automatic-list-creation"></A>
<BR>
20.3 Automatic list creation
</H1>

<P>
You can benefit from the family concept to let Sympa automatically create lists for you.
 Let us suppose that you want to open a list according to specified criteria (age, geographical site...) within your organization.
 Maybe that would result in too many lists, and many of them would never be used.

<P>
Automatic list creation allows you to define those potential lists through family parameters,
 but they won't be created yet. The mailing list creation is trigerred when Sympa receives a
 message addressed to this list.

<P>
To enable automatic list creation you'll have to :

<UL>
<LI>Configure your MTA to queue messages for these lists in an appropriate spool

<P>
</LI>
<LI>Define a family associated to such lists

<P>
</LI>
<LI>Configure Sympa to enable the feature

<P>
</LI>
</UL>

<P>

<H2><A NAME="SECTION002131000000000000000">
20.3.1 Configuring your MTA</A>
</H2>

<P>
To do so, we have to configure our MTA for it to add a custom header field to the message. The easiest way
 is to customize your aliases manager, so mails for automatic lists aren't delivered to the normal 
 <A NAME="10987"></A><TT>queue</TT> program, but to the <A NAME="10990"></A><TT>familyqueue</TT> dedicated one. For example, you can decide
 that the name of those lists will start with the <TT>auto-</TT> pattern, so you can process them separately
 from other lists you are hosting.

<P>
<A NAME="10993"></A><TT>familyqueue</TT> expects 2 arguments : the list name and the family name (whereas the <A NAME="10996"></A><TT>queue</TT> program
 only expects the list address).

<P>
Let's start with a use case : we need to communicate to groups of co-workers, depending on their age
 and their occupation. We decide that, for example, if I need to write to all CTOs who are fifty years old,
 I will use the auto-cto.50@lists.domain.com mailing list. The occupation and age informations are stored in our
 ldap directory (but of course we could use any Sympa data source : sql, files...). We will create the
 age-occupation family.

<P>
First of all we configure our MTA to deliver mail to  <TT>'auto-*'</TT> to  <A NAME="10999"></A><TT>familyqueue</TT>
 for the <TT>age-occupation</TT> family.

<P><PRE>
/etc/postfix/main.cf
    ...
    transport_maps = regexp:/etc/postfix/transport_regexp

/etc/postfix/transport_regexp
    /^.*+owner\@lists\.domain\.com$/      sympabounce:
    /^auto-.*\@lists\.domain\.com$/       sympafamily:
    /^.*\@lists\.domain\.com$/            sympa:

/etc/postfix/master.cf
    sympa     unix  -       n       n       -       -       pipe
      flags=R user=sympa argv=/usr/local/sympa-os/bin/queue ${recipient}
    sympabounce  unix  -       n       n       -       -       pipe
      flags=R user=sympa argv=/usr/local/sympa-os/bin/bouncequeue ${user}
    sympafamily  unix  -       n       n       -       -       pipe
      flags=R user=sympa argv=/usr/local/sympa-os/bin/familyqueue ${user} age-occupation
</PRE> 

<P>
A mail addressed to <I>auto-cto.50@lists.domain.com</I> will be queued to the <A NAME="11002"></A><TT>/usr/local/sympa-os/spool/automatic</TT> spool, 
defined by the <A NAME="11005"></A><TT>queueautomatic</TT> <A NAME="11008"></A><TT>sympa.conf</TT> parameter (see <A HREF="node8.html#kw-queueautomatic">7.6.11</A>, page&nbsp;<A HREF="node8.html#kw-queueautomatic"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>).
The mail will first be processed by an instance of <A NAME="11011"></A><TT>sympa.pl</TT> process dedicated to automatic list creation, then the mail
will be sent to the newly created mailing list.

<P>

<H2><A NAME="SECTION002132000000000000000">
20.3.2 Defining the list family</A>
</H2>

<P>
We need to create the appropriate <A NAME="11014"></A><TT>etc/families/age-occupation/config.tt2</TT>. All the magic comes
from the TT2 language capabilities. We define on-the-fly the LDAP source, thanks to TT2 macros.

<P><PRE>
/home/sympa/etc/families/age-occupation/config.tt2
    ...
    user_data_source include2
    
    [%
    occupations = {
        cto = { title=&gt;"chief technical officer", abbr=&gt;"CHIEF TECH OFF" },
        coo = { title=&gt;"chief operating officer", abbr=&gt;"CHIEF OPER OFF" },
        cio = { title=&gt;"chief information officer", abbr=&gt;"CHIEF INFO OFF" },
    }
    nemes = listname.split('-');
    THROW autofamily "SYNTAX ERROR : listname must begin with 'auto-' " IF (nemes.size != 2 || nemes.0 != 'auto');
    tokens = nemes.1.split('\.');
    THROW autofamily "SYNTAX ERROR : wrong listname syntax" IF (tokens.size != 2 || ! occupations.${tokens.0} || tokens.1 &lt; 20 || tokens.1 &gt; 99 );
    age = tokens.1 div 10;
    %]

    custom_subject [[% occupations.${tokens.0}.abbr %] OF [% tokens.1 %]]

    subject Every [% tokens.1 %] years old [% occupations.${tokens.0}.title %]

    include_ldap_query
    attrs mail
    filter (&amp;(objectClass=inetOrgPerson)(employeeType=[% occupations.${tokens.0}.abbr %])(personAge=[% age %]*))
    name ldap
    port 389
    host ldap.domain.com
    passwd ldap_passwd
    suffix dc=domain,dc=com
    timeout 30
    user cn=root,dc=domain,dc=com
    scope sub
    select all
</PRE> 

<P>
The main variable you get is the name of the current mailing list via the <B>listname</B> variable as used in the example above.

<P>

<H2><A NAME="SECTION002133000000000000000">
20.3.3 Configuring Sympa</A>
</H2>

<P>
Now we need to enable automatic list creation in Sympa. To do so, we have to 

<UL>
<LI>set the <A NAME="11017"></A><TT>automatic_list_feature</TT> parameter to <TT>on</TT> and define who can create automatic lists via
  the <A NAME="11020"></A><TT>automatic_list_creation</TT> (points to an automatic_list_creation scenario).

<P>
</LI>
<LI>set the <A NAME="11023"></A><TT>queueautomatic</TT> <A NAME="11026"></A><TT>sympa.conf</TT> parameter to the spool location where we want these messages to
  be stored (it has to be different from the <A NAME="11029"></A><TT>/usr/local/sympa-os/spool/msg</TT> spool).

<P>
</LI>
</UL>

<P>
You can make Sympa delete automatic lists that were created with zero list members ; to do so
you shoukd set the <A NAME="11032"></A><TT>automatic_list_removal</TT> parameter to <TT>if_empty</TT>.

<P><PRE>
/home/sympa/etc/sympa.conf
    ...
    automatic_list_feature  on
    automatic_list_creation public
    queueautomatic          /usr/local/sympa-os/spool/automatic
    automatic_list_removal    if_empty
</PRE> 

<P>
While writing your own <A NAME="11035"></A>automatic_list_creation  scenarios, be aware that :

<UL>
<LI>when the scenario is evaluated, the list is not yet created ; therefore you can't use the list-related
  variables.

<P>
</LI>
<LI>You can only use 'smtp' and 'smime' authentication method in scenario rules (You cannot request the md5 challenge).
  Moreover only <TT>do_it</TT> and <TT>reject</TT> actions are available.

<P>
</LI>
</UL>

<P>
Now you can send message to auto-cio.40 or auto-cto.50, and the lists will be created on the fly.

<P>
You will receive an 'unknown list' error if either the syntax is incorrect or the number of subscriber is zero.

<P>

<HR>
<!--Navigation Panel-->
<A NAME="tex2html1390"
  HREF="node22.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html1384"
  HREF="sympa.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html1378"
  HREF="node20.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html1386"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A> 
<A NAME="tex2html1388"
  HREF="node31.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png"></A> 
<BR>
<B> Next:</B> <A NAME="tex2html1391"
  HREF="node22.html">21. List configuration parameters</A>
<B> Up:</B> <A NAME="tex2html1385"
  HREF="sympa.html">Sympa Mailing Lists Management Software version</A>
<B> Previous:</B> <A NAME="tex2html1379"
  HREF="node20.html">19. List creation, edition and removal</A>
 &nbsp; <B>  <A NAME="tex2html1387"
  HREF="node1.html">Contents</A></B> 
 &nbsp; <B>  <A NAME="tex2html1389"
  HREF="node31.html">Index</A></B> 
<!--End of Navigation Panel-->
<ADDRESS>
root
2006-11-21
</ADDRESS>
</BODY>
</HTML>
