
<H1><A NAME="SECTION00900000000000000000"><tex2html_anchor_invisible_mark></A>
<A NAME="sec-rdbms"><tex2html_anchor_mark></A><BR>
8. <I>Sympa</I> and its database
</H1>

<P>
Most basic feature of <I>Sympa</I> will work without a RDBMS, but WWSympa and bounced require a relational database. 
Currently you can use one of the following RDBMS : MySQL, PostgreSQL, Oracle, Sybase. Interfacing with other RDBMS
requires only a few changes in the code, since the API used, <A NAME="tex2html19"
  HREF="http://www.symbolstone.org/technology/perl/DBI/">DBI</A>
(DataBase Interface), has DBD (DataBase Drivers) for many RDBMS.

<P>
Sympa stores three kind of information in the database, each in one table :

<UL>
<LI>User preferences and passwords are stored in the <A NAME="8028"><tex2html_anchor_invisible_mark></A>user_table  table

<P>
</LI>
<LI>List subscription informations are stored in the <A NAME="8029"><tex2html_anchor_invisible_mark></A>subscriber_table  table, along with subscription options.
  This table also contains the cache for included users (if using include2 mode).

<P>
</LI>
<LI>List administrative informations are stored in the <A NAME="8030"><tex2html_anchor_invisible_mark></A>admin_table  table if using include2 mode, along with owner and editor options. This table also contains the cache for included owners and editors.

<P>
</LI>
</UL>

<P>

<H1><A NAME="SECTION00910000000000000000">
8.1 Prerequisites</A>
</H1>

<P>
You need to have a DataBase System installed (not necessarily 
on the same host as <I>Sympa</I>), and the client libraries for that
Database installed on the <I>Sympa</I> host ; provided, of course, that
a PERL DBD (DataBase Driver) is available for your chosen RDBMS!
Check the <A NAME="tex2html20"
  HREF="http://www.symbolstone.org/technology/perl/DBI/"><TT>DBI</TT> Module Availability</A>.

<P>

<H1><A NAME="SECTION00920000000000000000">
8.2 Installing PERL modules</A>
</H1>

<P>
<I>Sympa</I> will use <A NAME="8037"><tex2html_anchor_invisible_mark></A><TT>DBI</TT> to communicate with the database system and
therefore requires the DBD for your database system. DBI and 
DBD::YourDB (<A NAME="8040"><tex2html_anchor_invisible_mark></A><TT>Msql-Mysql-modules</TT> for MySQL) are distributed as 
CPAN modules. Refer to ~<A HREF=<tex2html_cr_mark>#Install_PERL_and_CPAN_modules#1237><tex2html_cr_mark></A>, 
page~<A HREF=<tex2html_cr_mark>#Install_PERL_and_CPAN_modules#1238><tex2html_cross_ref_visible_mark></A> for installation
details of these modules.

<P>

<H1><A NAME="SECTION00930000000000000000">
8.3 Creating a sympa DataBase</A>
</H1>

<P>

<H2><A NAME="SECTION00931000000000000000">
8.3.1 Database structure</A>
</H2>

<P>
The sympa database structure is slightly different from the
structure of a <A NAME="8043"><tex2html_anchor_invisible_mark></A><TT>subscribers</TT> file. A <A NAME="8046"><tex2html_anchor_invisible_mark></A><TT>subscribers</TT>
file is a text file based on paragraphs (similar to 
the <A NAME="8049"><tex2html_anchor_invisible_mark></A><TT>config</TT> file) ; each paragraph completely describes 
a subscriber. If somebody is subscribed to two lists, he/she 
will appear in both subscribers files.

<P>
The DataBase distinguishes information relative to a person (e-mail,
real name, password) and his/her subscription options (list
concerned, date of subscription, reception option, visibility 
option). This results in a separation of the data into two tables :
the user_table and the subscriber_table, linked by a user/subscriber e-mail.

<P>
The table concerning owners and editors, the admin_table, is made on the same way as 
the subscriber_table but is used only in include2 mode. It constains owner and editor 
options (list concerned, administrative role, date of ``subscription'', reception option, 
private info, gecos and profile option for owners).

<P>

<H2><A NAME="SECTION00932000000000000000">
8.3.2 Database creation</A>
</H2>

<P>
The <A NAME="8052"><tex2html_anchor_invisible_mark></A><TT>create_db</TT> script below will create the sympa database for 
you. You can find it in the <A NAME="8055"><tex2html_anchor_invisible_mark></A><TT>script/</TT> directory of the 
distribution (currently scripts are available for MySQL, PostgreSQL, Oracle and Sybase).

<P>

<UL>
<LI>MySQL database creation script
<BR>	<BLOCKQUOTE>
</BLOCKQUOTE><PRE><tex2html_verbatim_mark>verbatim294#</PRE><BLOCKQUOTE>
</BLOCKQUOTE>

<P>
</LI>
<LI>PostgreSQL database creation script
<BR>	<BLOCKQUOTE>
</BLOCKQUOTE><PRE><tex2html_verbatim_mark>verbatim295#</PRE><BLOCKQUOTE>
</BLOCKQUOTE>

<P>
</LI>
<LI>Sybase database creation script
<BR>	<BLOCKQUOTE>
</BLOCKQUOTE><PRE><tex2html_verbatim_mark>verbatim296#</PRE><BLOCKQUOTE>
</BLOCKQUOTE>

<P>
</LI>
<LI>Oracle database creation script
<BR>	<BLOCKQUOTE>
</BLOCKQUOTE><PRE><tex2html_verbatim_mark>verbatim297#</PRE><BLOCKQUOTE>
</BLOCKQUOTE>

<P>
</LI>
</UL>

<P>
You can execute the script using a simple SQL shell such as
mysql, psql or sqlplus.

<P>
Example:

<P>
<BLOCKQUOTE>
</BLOCKQUOTE><PRE><tex2html_verbatim_mark>verbatim298#</PRE><BLOCKQUOTE>
</BLOCKQUOTE>

<P>

<H1><A NAME="SECTION00940000000000000000">
8.4 Setting database privileges</A>
</H1>

<P>
We strongly recommend you restrict access to <I>sympa</I> database. You will
then set <A NAME="8058"><tex2html_anchor_invisible_mark></A><TT>db_user</TT> and <A NAME="8061"><tex2html_anchor_invisible_mark></A><TT>db_passwd</TT> in <A NAME="8064"><tex2html_anchor_invisible_mark></A><TT>sympa.conf</TT>.

<P>
With <A NAME="8067"><tex2html_anchor_invisible_mark></A>MySQL :
<BLOCKQUOTE>
</BLOCKQUOTE><PRE><tex2html_verbatim_mark>verbatim299#</PRE><BLOCKQUOTE>
</BLOCKQUOTE>

<P>

<H1><A NAME="SECTION00950000000000000000">
8.5 Importing subscribers data</A>
</H1>

<P>

<H2><A NAME="SECTION00951000000000000000">
8.5.1 Importing data from a text file</A>
</H2>

<P>
You can import subscribers data into the database from a text file having one entry per line : the first field is 
an e-mail address, the second (optional) field is the free form name.  Fields are spaces-separated.

<P>
Example:
<BLOCKQUOTE>
</BLOCKQUOTE><PRE><tex2html_verbatim_mark>verbatim300#</PRE><BLOCKQUOTE>
</BLOCKQUOTE>

<P>
To import data into the database :

<P>
<BLOCKQUOTE>
</BLOCKQUOTE><PRE><tex2html_verbatim_mark>verbatim301#</PRE><BLOCKQUOTE>
</BLOCKQUOTE>

<P>
(see <A HREF=<tex2html_cr_mark>#sympa.pl#1289><tex2html_cr_mark></A>, page~<A HREF=<tex2html_cr_mark>#sympa.pl#1290><tex2html_cross_ref_visible_mark></A>).

<P>

<H2><A NAME="SECTION00952000000000000000">
8.5.2 Importing data from subscribers files</A>
</H2>

<P>
If a mailing list was previously setup to store subscribers into 
<A NAME="8068"><tex2html_anchor_invisible_mark></A><TT>subscribers</TT> file (the default mode in versions older then 2.2b) 
you can load subscribers data into the sympa database. The easiest way
is to edit the list configuration using <A NAME="8071"><tex2html_anchor_invisible_mark></A><I>WWSympa</I> (this requires listmaster 
privileges) and change the data source from <B>file</B> to <B>database</B>
; subscribers data will be loaded into the database at the same time.

<P>
If the subscribers file is big, a timeout may occur during the FastCGI execution
(Note that you can set a longer timeout with the <A NAME="8074"><tex2html_anchor_invisible_mark></A><TT>-idle-timeout</TT> option of
the <TT>FastCgiServer</TT> Apache configuration directive). In this case, or if you have not installed <A NAME="8077"><tex2html_anchor_invisible_mark></A><I>WWSympa</I>, you should use the <A NAME="8080"><tex2html_anchor_invisible_mark></A><TT>load_subscribers.pl</TT> script.

<P>

<H1><A NAME="SECTION00960000000000000000"><tex2html_anchor_invisible_mark></A>
<A NAME="include2-cache"><tex2html_anchor_mark></A><BR>
8.6 Management of the include cache
</H1>

<P>
You may dynamically add a list of subscribers, editors or owners to a list with Sympa's <B>include2</B> user data source. Sympa is able to query
multiple data sources (RDBMS, LDAP directory, flat file, a local list, a remote list) to build a mailing list. 

<P>
Sympa used to manage the cache of such <I>included</I> subscribers in a DB File (<B>include</B> mode) but now stores
subscribers, editors and owners in the database (<B>include2</B> mode). These changes brought the following advantages :

<UL>
<LI>Sympa processes are smaller when dealing with big mailing lists (in include mode)

<P>
</LI>
<LI>Cache update is now performed regularly by a dedicated process, the task manager

<P>
</LI>
<LI>Mixed lists (included + subscribed users) can now be created

<P>
</LI>
<LI>Sympa can now provide reception options for <I>included</I> members

<P>
</LI>
<LI>Bounces information can be managed for <I>included</I> members

<P>
</LI>
<LI>Sympa keeps track of the data sources of a member (available on the web REVIEW page)

<P>
</LI>
<LI><I>included</I> members can also subscribe to the list. It allows them to remain in the list though they might no more be included.

<P>
</LI>
</UL>

<P>

<H1><A NAME="SECTION00970000000000000000">
8.7 Extending database table format</A>
</H1>

<P>
You can easily add other fields to the three tables, they will not disturb <I>Sympa</I> because it lists
explicitely the field it expects in SELECT queries.

<P>
Moreover you can access these database fields from within <I>Sympa</I> 
(in templates), as far as you list these additional fields in
<A NAME="8085"><tex2html_anchor_invisible_mark></A><TT>sympa.conf</TT> (See <A HREF=<tex2html_cr_mark>#db-additional-subscriber-fields#1311><tex2html_cr_mark></A>, page~<A HREF=<tex2html_cr_mark>#db-additional-subscriber-fields#1312><tex2html_cross_ref_visible_mark></A>
and <A HREF=<tex2html_cr_mark>#db-additional-user-fields#1313><tex2html_cr_mark></A>, page~<A HREF=<tex2html_cr_mark>#db-additional-user-fields#1314><tex2html_cross_ref_visible_mark></A>).

<P>

<H1><A NAME="SECTION00980000000000000000">
8.8 <I>Sympa</I> configuration</A>
</H1>

<P>
To store subscriber information in your newly created
database, you first need to tell <I>Sympa</I> what kind of
database to work with, then you must configure
your list to access the database.

<P>
You define the database source in <A NAME="8090"><tex2html_anchor_invisible_mark></A><TT>sympa.conf</TT> :
<A NAME="8093"><tex2html_anchor_invisible_mark></A><TT>db_type</TT>, <A NAME="8096"><tex2html_anchor_invisible_mark></A><TT>db_name</TT>, 
<A NAME="8099"><tex2html_anchor_invisible_mark></A><TT>db_host</TT>, <A NAME="8102"><tex2html_anchor_invisible_mark></A><TT>db_user</TT>, 
<A NAME="8105"><tex2html_anchor_invisible_mark></A><TT>db_passwd</TT>.

<P>
If you are interfacing <I>Sympa</I> with an Oracle database, 
<A NAME="8109"><tex2html_anchor_invisible_mark></A><TT>db_name</TT> is the SID.

<P>
All your lists are now configured to use the database,
unless you set list parameter <A NAME="8112"><tex2html_anchor_invisible_mark></A><TT>user_data_source</TT> 
to <B>file</B> or <B>include</B>. 

<P>
<I>Sympa</I> will now extract and store user
information for this list using the database instead of the
<A NAME="8116"><tex2html_anchor_invisible_mark></A><TT>subscribers</TT> file. Note however that subscriber information is 
dumped to <A NAME="8119"><tex2html_anchor_invisible_mark></A><TT>subscribers.db.dump</TT> at every shutdown, 
to allow a manual rescue restart (by renaming subscribers.db.dump to
subscribers and changing the user_data_source parameter), if ever the
database were to become inaccessible.

<P>

