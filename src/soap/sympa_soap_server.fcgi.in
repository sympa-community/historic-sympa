#! --PERL--
# -*- indent-tabs-mode: t; -*-
# vim:ft=perl:et:sw=4:textwidth=78
# $Id$

use strict;
use lib '--modulesdir--';

use English qw(-no_match_vars);
use SOAP::Lite;
#use SOAP::Lite +trace;
## Defines SOAP::Transport::HTTP::FCGI::Sympa with a modified handle()
use SOAP::Transport::HTTP;

use Sympa::Configuration;
#XXXuse Sympa::Constants;
use Sympa::Database;
use Sympa::List;
use Sympa::Log::Syslog;
use Sympa::Mail;
use Sympa::SOAP;
use Sympa::Transport;
use Sympa::WWSympa;

my $birthday = time();

## Load sympa config
unless (defined Sympa::Robot::get_robots()) {
	Sympa::Log::Syslog::fatal_err(
		'Unable to load sympa configuration, file %s or one of the virtual host robot.conf files contain errors. Exiting.',
		Conf::get_sympa_conf()
	);
}

Sympa::Log::Syslog::set_log_level(Sympa::Site->log_level);

## Open log
Sympa::Log::Syslog::do_openlog(Sympa::Site->log_facility, Sympa::Site->log_socket_type, 'soap');
Sympa::Log::Syslog::do_log('info', 'SOAP server launched');

## We set the real UID with the effective UID value
## It is usefull to allow execution of scripts like alias_manager
## that otherwise might loose the benefit of SetUID
$UID = $EUID; ## UID
$GID = $EGID; ## GID

# connect to database
my $db_conf = Sympa::Configuration::get_parameters_group(
	'*','Database related'
);

my $base = Sympa::Database->create(%$db_conf);
unless ($base) {
	Sympa::Log::Syslog::fatal_err(
		'Unable to create database defined in configuration. Exiting.'
	);
}

my $result = $base->connect();
unless ($result) {
	Sympa::Log::Syslog::fatal_err(
		'Unable to connect to database defined in configuration. Exiting.'
	);
}

my $pinfo = Sympa::List::_apply_defaults();

# spool messages instead of sending them
my $spool = Sympa::Spool->new(
	name => Sympa::Site->queue,
	base => $base
);

## Loading all Lists at startup, in order to increase execution speed
Sympa::List::get_lists('Site');

my $all_lists = Sympa::List::get_lists('*');
foreach my $list (@$all_lists){
    ## Nothing to do here
 }


##############################################################################################
#    Soap part
##############################################################################################

my $server = Sympa::Transport->new(); 

#$server->dispatch_with({'urn:Sympa' => 'sympasoap'});
$server->dispatch_to('--modulesdir--','Sympa::SOAP');

$server->handle($birthday);

