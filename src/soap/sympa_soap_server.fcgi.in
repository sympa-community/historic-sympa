#! --PERL--
# -*- indent-tabs-mode: t; -*-
# vim:ft=perl:noet:sw=8:textwidth=78
# $Id$

use strict;
use lib '--modulesdir--';

use English qw(-no_match_vars);
use SOAP::Lite;
#use SOAP::Lite +trace;
## Defines SOAP::Transport::HTTP::FCGI::Sympa with a modified handle()
use SOAP::Transport::HTTP;

use Sympa::Configuration;
use Sympa::Constants;
use Sympa::Database;
use Sympa::List;
use Sympa::Log::Syslog;
use Sympa::Mail;
use Sympa::SOAP;
use Sympa::Transport;
use Sympa::WWSympa;

my $birthday = time();

## Configuration
my $wwsconf = {};

## Change to your wwsympa.conf location
my $conf_file       = Sympa::Constants::WWSCONFIG;
my $sympa_conf_file = Sympa::Constants::CONFIG;

## Load config 
unless ($wwsconf = Sympa::WWSympa::load_config($conf_file)) {
    Sympa::Log::Syslog::fatal_err("Unable to load sympa configuration, file $conf_file or one of the vhost robot.conf files contain errors. Exiting.");  
}

## Load sympa config
unless (Sympa::Configuration::load($sympa_conf_file)) {
    Sympa::Log::Syslog::fatal_err("Unable to load sympa configuration, file $sympa_conf_file or one of the vhost robot.conf files contain errors. Exiting.");  
}

Sympa::Log::Syslog::set_log_level($Sympa::Configuration::Conf{'log_level'}) if ($Sympa::Configuration::Conf{'log_level'}); 


## Open log
$wwsconf->{'log_facility'}||= $Sympa::Configuration::Conf{'syslog'};

Sympa::Log::Syslog::do_openlog($wwsconf->{'log_facility'}, $Sympa::Configuration::Conf{'log_socket_type'}, 'soap');
Sympa::Log::Syslog::do_log('info', 'SOAP server launched');

## We set the real UID with the effective UID value
## It is usefull to allow execution of scripts like alias_manager
## that otherwise might loose the benefit of SetUID
$UID = $EUID; ## UID
$GID = $EGID; ## GID

unless (Sympa::Database::check_db_connect()) {
    Sympa::Log::Syslog::do_log('err','SOAP server requires a RDBMS to run');
}

my $pinfo = Sympa::List::_apply_defaults();

# spool messages instead of sending them
my $spool = Sympa::Spool->new(
	name => $Sympa::Configuration::Conf{'queue'},
	base => Sympa::Database->get_singleton()
);

## Loading all Lists at startup, in order to increase execution speed

my $all_lists = Sympa::List::get_lists('*');
foreach my $list (@$all_lists){
    ## Nothing to do here
 }


##############################################################################################
#    Soap part
##############################################################################################

my $server = Sympa::Transport->new(); 

#$server->dispatch_with({'urn:Sympa' => 'sympasoap'});
$server->dispatch_to('--modulesdir--','Sympa::SOAP');

$server->handle($birthday);

